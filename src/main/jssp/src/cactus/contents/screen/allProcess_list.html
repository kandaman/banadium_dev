<imart type="head">
  <title>全案件一覧</title>

<IMART type="jsspRpc" name="searchListObj" page="cactus/contents/screen/allProcess_list"></IMART>
<imart type="workflowOpenPageCsjs" />


<imart type="include" page="im_workflow/common/parts/window_popup/imw_window_popup" />
<!-- stylesheet -->
  <link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
	integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
	crossorigin="anonymous">  
  <link rel="stylesheet" href="cactus_csjs/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="cactus_csjs/bootstrap-datepicker.min.css">

  <!-- mycontents -->
  <script type="text/javascript" src="cactus_csjs/const.js"></script>
  <script type="text/javascript" src="cactus_csjs/proc.js"></script>
  <script type="text/javascript" src="cactus_csjs/sksgjs.js"></script>
  <script type="text/javascript" src="cactus_csjs/addpf.js"></script>
  <script type="text/javascript" src="cactus_csjs/pager.js"></script>
  <script type="text/javascript" src="cactus_csjs/common.js"></script>
     
  <link rel="stylesheet" href="cactus_csjs/sksg.css">
  <link rel="stylesheet" href="cactus_csjs/step_bar.css">
  <link rel="stylesheet" href="cactus_csjs/frozen-header.css">
  
  <!-- workflow/csjs/greybox.jsの　showGreyBoxを変更 -->
  <script type="text/javascript" src="workflow/csjs/greybox_cactus.js"></script>
  
  
  
  
<script>
var $searchListData=[];

//ページ情報
var $searchPageInfo={
	maxRow: 10 //１ページの最大行数
    ,MaxLinks:5 //リンク表示の最大数
	,totalPage:1 //ページ数（件数/最大行数）
};  

// 詳細
function onClickDetail(imwSystemMatterId, imwUserDataId, imwPageType) {
    document.detailForm.imwPageType.value = imwPageType;
    document.detailForm.imwSystemMatterId.value = imwSystemMatterId;
    document.detailForm.imwUserDataId.value = imwUserDataId;
    openPopupWindowDetail(document.detailForm);
}
//確認画面
function onClickConfirm(imwSystemMatterId, imwUserDataId, imwNodeId, imwPageType) {
    $('#workflowOpenPageForm').find('#imwUserDataId').val(imwUserDataId); 
    $('#workflowOpenPageForm').find('#imwSystemMatterId').val(imwSystemMatterId); 

    $('#workflowOpenPageForm').find('#imwNodeId').val(imwNodeId); 
    //$('#workflowOpenPageForm').find('#imwFlowId').val(imwNodeId); 
    $('#workflowOpenPageForm').find('#imwApplyBaseDate').val(getNowData()); 
    //$('#workflowOpenPageForm').find('#imwAuthUserCode').val(); 
    
    // 処理用ページを変更する
    var nodeSetting = {
	  	  "procPage" : "im_workflow/common/proc/custom/confirm/confirm", //申請画面をデフォルトから変更 WEB-INF\conf\routing-jssp-config\im_workflow.xmlにパスを設定しておく
	  };
    $('#imwCustomParam').val(ImJson.toJSONString(nodeSetting));    	  

    workflowOpenPage('6'); // 標準画面に遷移
    return false;
}


$(function() {
	
	// ページ移動
	$(document).on("click",'#searchPager li',function(event){
		var pageNum =$(this).attr('page');
		// ページャー移動
		onPagerMove('searchPager',pageNum);
		// 表示データ
		onPagerlistDrawTbody("processlist",pageNum,$searchPageInfo.maxRow);
	});
	
	// 検索条件リセット
	$("#btn_reset").click(function() {
		$("#searchfrom")[0].reset();
	});
	

	// Excel出力
	/*$("#btn_excel").click(function() {
		alert('on2');
		ret = searchListObj.createExcel($searchListData);
	});*/
	$("#btn_excel,#btn_excel2").click(function() {
		if ($searchListData.length > 0){
			$("#excelJson").val(ImJson.toJSONString($searchListData));
			$("#excelForm").submit();
			return false;
		}else{
	    	return imwShowErrorMessage('imui-container',"検索結果がありません");
		}
		
	});
	

	// 絞り込み条件変更時
	$('input[name=search_type]:radio').change( function() {  
		// 未完了ならコンボボックス使用可
		if ($(this).val() =="proc"){
			$("#status_kbn").prop("disabled", false);
		}else{
			$("#status_kbn").val("")
			$("#status_kbn").prop("disabled", true);
		}
	});  

	
	// 検索処理
	$("#btn_searchList").click(function() {
		//中身をクリア
		//$("#processlist").children().remove();
		$("#processlist .resultBody").remove();

		// 検索条件
		var where = {
			"shinsei_no":$.trim($("#shinsei_no").val())
			,"shinsei_typ_cd": $.trim($("#sheet_type").val())
			,"region": $.trim($("#region").val())
			,"character_nm": $.trim($("#character_nm").val())
			,"hanmoto_nm": $.trim($("#hanmoto_nm").val())
			,"titel_nm": $.trim($("#titel_nm").val())
			,"status_kbn": $.trim($("#status_kbn").val())
			,"toroku_kekka_kbn": $.trim($("#toroku_kekka_kbn").val())
			,"kiansha_nm": $.trim($("#kiansha_nm").val())
			,"kian_busyo": $.trim($("#kian_busyo").val())
			,"tantosha_nm": $.trim($("#tantosha_nm").val())
		};
		var sort = [
			 {"sortkey":$("#sort_key1").val(),"sorttype": $("#sort_type1").val()}
			,{"sortkey":$("#sort_key2").val(),"sorttype": $("#sort_type2").val()}
			,{"sortkey":$("#sort_key3").val(),"sorttype": $("#sort_type3").val()}
		];
		
		var search_type = $('input[name=search_type]:checked').val()
		
		// 検索
		var ret;
		ret = searchListObj.getAllProcessList(search_type,where,sort);
		
        //行の最大件数
		$searchPageInfo.maxRow = $("#rowmax").val();
        
		$searchListData = [];
		if (ret.countRow > 0){
			$searchListData = ret.data;
			
			$searchPageInfo.totalPage = Math.ceil(ret.countRow / $searchPageInfo.maxRow);
			clreatePager('searchPager',$searchPageInfo.totalPage,$searchPageInfo.MaxLinks);

			$("#resultTable").show();
		}else{
			clreatePager('searchPager',0,$searchPageInfo.MaxLinks);
		}

		if (ret.countRow > 0){
			// data配列を順に処理
			$.each(ret.data,function(index, elem) {
				
				//テンプレート行をコピー
				var coln = $("#resultTemplate").clone(true);
				//id削除
				coln.removeAttr('id');
				coln.attr('class','resultBody');

				// ステータス：完了の場合は背景色変更
				if (elem.status_kbn=="04"){
					coln.attr('bgcolor','#d8d8d8');
				}

				//var href =  '<a href="javascript: void(0);" onclick="onClickProcess('+elem.system_matter_id+','+elem.user_data_id+','+elem.node_id+',4); return false;">'+elem.shinsei_no+'</a>'
				  
				//データを反映
				coln.find('.id_status').text(elem.status_name);
				// リンク先詳細
				//coln.find('.id_sinsei_no').attr("onclick", "onClickDetail('"+elem.system_matter_id+"','"+elem.im_user_data_id+"','6'); return false;");
				coln.find('.id_sinsei_no').attr("onclick", "onClickConfirm('"+elem.system_matter_id+"','"+elem.im_user_data_id+"','','6'); return false;");
				coln.find('.id_sinsei_no').text(elem.shinsei_no);
				coln.find('.id_character').text(elem.character_nms);
				coln.find('.id_hanmoto').text(elem.hanmoto_nms);
				coln.find('.id_titel').text(elem.title_nm);
				coln.find('.id_kekka').text(elem.toroku_kekka_nm);
				coln.find('.id_update').text(elem.koshin_dt);
				coln.find('.id_busho').text(elem.kian_busyo);
				coln.find('.id_tantou').text(elem.tantosha_nm);				
				coln.find('.id_region').text(elem.region_type);
				coln.find('.id_type').text(elem.shinsei_typ_nm);
				coln.find('.id_create_user').text(elem.kiansha_nm);
				coln.find('.id_create_date').text(elem.toroku_dt);
				
				// 末尾に追加
				if (index < $searchPageInfo.maxRow){
					coln.show();
				}
				coln.appendTo("#processlist");
			});

			// 件数表示
			$("#searchDataCount").text("検索結果 ： " + ret.countRow + "件");
		}else{
			$("#searchDataCount").text("検索結果 ： 0件");
		}
	});
		
});
</script>
  
  
  
  
  
</imart>

<body>

<!-- 帳票印刷 -->
<IMART type="form" id="excelForm" action="createExcel" method="POST">

	<input type="hidden" name="excelJson" id="excelJson" value="" />
</IMART>



<!-- ナビバー -->
<IMART type="include" page="cactus/contents/screen/navibar" data=$data></IMART>
<!-- @end ナビバー -->

	<h2 style="margin-left: 20px;">全案件一覧</h2>
	<!-- 検索条件 -->
	<form id="searchfrom" >
	<div class="form-group" style="width: 80%; margin-top: 30px;">
		<!--  <label>絞り込み条件</label>-->
		<div class="panel">
			<table class="table table-bordered table-condensed">
				<tr>
					<th>絞り込み</th>
					<td colspan="9"><div class="radio form-inline">
							<label><input type="radio" name="search_type" value="all"> すべて</label> &nbsp;&nbsp;&nbsp;&nbsp;
							 <label><input type="radio" name="search_type" value="end" checked> 完了</label>&nbsp;&nbsp;&nbsp;&nbsp; 
							 <label><input type="radio" name="search_type" value="proc"> 未完了</label>
							 <select class="form-control input-sm" style="width: auto;" id="status_kbn" disabled>
								<option value=""></option>
								<option value="01">事業部承認待ち</option>
								<option value="02">メディア部受付待ち</option>
								<option value="03">版権元確認中</option>
							</select>
						</div></td>
				</tr>
				<tr>
					<th>申請番号</th>
					<td><input type="text" class="form-control input-sm" id="shinsei_no" ></td>
					<th>地域</th>
					<td><select class="form-control input-sm" id="region">
							<option value="">全て</option>
							<option value="00">国内</option>
							<option value="11">海外</option>
							<option value="01">国内/海外</option>
					</select></td>
					<th>申請書種類</th>
					<td><select class="form-control input-sm" id="sheet_type">
							<option value="">全て</option>
							<option value="1">新商品企画申請書</option>
							<option value="2">販促物企画申請書</option>
							<option value="3">ダウンロードコンテンツ申請書</option>
					</select></td>
					<th>キャラクター名</th>
					<td><input type="text" class="form-control input-sm" id="character_nm"></td>
					<th>版権元</th>
					<td><input type="text" class="form-control input-sm" id="hanmoto_nm"></td>
				</tr>
				<tr>

					<th>タイトル名/件名</th>
					<td><input type="text" class="form-control input-sm" id="titel_nm"></td>
					<th>登録結果</th>
					<td><select class="form-control input-sm" id="toroku_kekka_kbn">
							<option value="">全て</option>
							<option value="04">登録OK</option>
							<option value="05">登録NG</option>
							<option value="06">登録一部NG</option>
					</select></td>
					<th>起案部署</th>
					<td><input type="text" class="form-control input-sm" id="kian_busyo"></td>
					<th>起案者</th>
					<td><input type="text" class="form-control input-sm" id="kiansha_nm"></td>
					<th>メディア担当</th>
					<td><input type="text" class="form-control input-sm" id="tantosha_nm"></td>
				</tr>
				<tr>
					<th>並び順</th>
					<td colspan="5" class="form-inline">
							<select class="form-control input-sm" style="margin-right: 5px" id="sort_key1">
								<option value="1">ステータス</option>
								<option value="2" selected>申請番号</option>
								<option value="3">地域</option>
								<option value="4">申請書種類</option>
								<option value="5">キャラクター名</option>
								<option value="6">版権元</option>
								<option value="7">タイトル名/件名</option>
								<option value="8">登録結果</option>
								<option value="9">起案部署</option>
								<option value="10">起案者</option>
								<option value="11">起案日時</option>
								<option value="12">最終更新日時</option>
								<option value="13">メディア担当</option>
							</select>
							<select class="form-control input-sm" style="margin-right: 20px" id="sort_type1">
								<option value="ASC">昇順</option>
								<option value="DESC">降順</option>
							</select>
							<select class="form-control input-sm" style="margin-right: 5px" id="sort_key2">
								<option value="1" selected>ステータス</option>
								<option value="2">申請番号</option>
								<option value="3">地域</option>
								<option value="4">申請書種類</option>
								<option value="5">キャラクター名</option>
								<option value="6">版権元</option>
								<option value="7">タイトル名/件名</option>
								<option value="8">登録結果</option>
								<option value="9">起案部署</option>
								<option value="10">起案者</option>
								<option value="11">起案日時</option>
								<option value="12">最終更新日時</option>
								<option value="13">メディア担当</option>
							</select>
							<select class="form-control input-sm" style="margin-right: 20px" id="sort_type2">
								<option value="ASC">昇順</option>
								<option value="DESC">降順</option>
							</select>
							<select class="form-control input-sm" style="margin-right: 5px" id="sort_key3">
								<option value="1">ステータス</option>
								<option value="2">申請番号</option>
								<option value="3">地域</option>
								<option value="4" selected>申請書種類</option>
								<option value="5">キャラクター名</option>
								<option value="6">版権元</option>
								<option value="7">タイトル名/件名</option>
								<option value="8">登録結果</option>
								<option value="9">起案部署</option>
								<option value="10">起案者</option>
								<option value="11">起案日時</option>
								<option value="12">最終更新日時</option>
								<option value="13">メディア担当</option>
							</select>
							<select class="form-control input-sm" style="margin-right: 20px" id="sort_type3">
								<option value="ASC">昇順</option>
								<option value="DESC">降順</option>
							</select>
					</td>
					<th>表示件数</th>
					<td colspan="3" class="form-inline">
							<!-- <form class="form-inline"> -->
							<select class="form-control " id="rowmax">
								<option value=10>10件</option>
								<option value=20>20件</option>
								<option value=50 selected>50件</option>
								<option value=100>100件</option>
							</select>
						<!-- </form> -->
					</td>
				</tr>
			</table>
		</div>
		<button type="button" class="btn btn-hensyu" style="width: auto" id="btn_searchList" >検索</button>
		<button type="button" class="btn btn-hensyu" style="width: auto" id='btn_reset'>条件リセット</button>
	</div>
	</form>


	<hr>

<!-- 結果表示部------------------------------------------------------------------------------------------------------- -->

	<div id="resultTable" style="display: ">
		<!-- @end結果行テンプレート -->
		<div class="button btn_excel" style="padding-bottom: 30px">
			<button type="button" class="btn btn-hensyu" style="width: auto;" id="btn_excel" >エクセル出力</button>
		</div>
		<!-- 一時保存一覧 表示-->
		<div style="float: left;">
			<label id="searchDataCount">検索結果 ： 0件</label>
		</div>
		
		<!-- ページャー -->
		<div id="searchPager" style="float: right;"></div>
			
		<div class="panel" style="clear: both;" id="info">
			<table class="table table-condensed" id="processlist">
				<thead>
					<tr>
						<th rowspan="2" style="width: 6%">ステータス</th>
						<th colspan="2">申請番号</th>
						<th rowspan="2" style="width: 20%">キャラクター名</th>
						<th rowspan="2" style="width: 15%">版権元</th>
						<th rowspan="2" style="width: 15%">タイトル名/件名</th>
						<th rowspan="2" style="width: 5%">登録結果</th>
						<th colspan="2">起案部署</th>
						<th rowspan="2" style="width: 5%">最終更新日時</th>
						<th rowspan="2" style="width: 10%">メディア担当</th>
					</tr>
					<tr>
						<th style="width: 7%">地域</th>
						<th style="width: 7%">申請書種類</th>
						<th style="width: 6%">起案者</th>
						<th style="width: 4%">起案日時</th>
					</tr>
				</thead>
			</table>
			<!-- @end 一覧表示 -->
		</div>
	</div>
	
		<!-- 結果行テンプレート -->
		<div style="display: none">
			<table class="table table-condensed">
				<tbody id="resultTemplate" style="display: none">
					<tr>
						<td rowspan="2" class="id_status">一時保存</td>
						<td colspan="2"><a class="id_sinsei_no" href="javascript: void(0);">SKSG17002738</a></td>
						<td rowspan="2" class="id_character">宇宙戦艦ﾔﾏﾄ2199</td>
						<td rowspan="2" class="id_hanmoto">株式会社東北新社</td>
						<td rowspan="2" class="id_titel">PSVita「スーパーロボット大戦Ｖ」ダウンロード通常版</td>
						<td rowspan="2" class="id_kekka">登録OK</td>
						<td colspan="2" class="id_busho">株式会社バンダイナムコエンターテインメント CS事業部 プロダクションDV</td>
						<td rowspan="2" class="id_update">2017/02/17 17:57</td>
						<td rowspan="2" class="id_tantou">井桁 啓 Kei Igeta</td> 
					</tr>
					<tr>
						<td class="id_region">国内/海外</td>
						<td class="id_type">新商品企画申請書</td>
						<td class="id_create_user">宮崎 あおば Aoba Miyazaki</td>
						<td class="id_create_date">2016/01/21 13:35</td>
					</tr>
				</tbody>
			</table>
		</div>
		<!-- @end結果行テンプレート -->
		<div class="button" style="padding-bottom: 30px">
			<button type="button" class="btn btn-hensyu" style="width: auto;" id="btn_excel2">エクセル出力</button>
		</div>
   <form id="detailForm" name="detailForm" method="POST" target="IMW_DETAIL" action="im_workflow/common/switch/switch_content_detail_cactus">
   <IMART type="hidden" imwPageType=""
       imwSystemMatterId="" imwUserDataId="" imwCallOriginalPagePath="cactus/contents/screen/fin"></IMART>
   </form>
   
<!-- 承認用画面を開く -->
<imart type="workflowOpenPage"
    name="workflowOpenPageForm"
    id="workflowOpenPageForm"
    method="POST"
    target="_top"
    imwUserDataId=""
    imwSystemMatterId=""
    imwAuthUserCode=$data.userId
    imwApplyBaseDate=""
    imwNodeId=""
    imwFlowId=""
    imwCallOriginalParams=""
    imwNextScriptPath="cactus/contents/screen/fin">
    
    <!-- ノード制御用カスタムロパティ -->
	<input type="hidden" name="imwCustomParam" id="imwCustomParam" >
    <!-- ノード設定 -->
	<input type="hidden" name="imwNodeSetting" id="imwNodeSetting" >
    
</imart>

</body>
</html>