<style type="text/css">
<!--
#title_select_table td {
  	word-break: break-word;
	white-space: normal;
}
table.dataTable td.dataTables_empty {
	border: 1px solid #c8c8cb;
}

.modal-z-index{
	z-index:99904 !important;
}
--> 
</style>
<script>
function addForwardZ(){
	$(".ui-datepicker").addClass("modal-z-index");
}

function removeForwardZ(){
	$(".ui-datepicker").removeClass("modal-z-index");
}

//モーダル用にZ-indexを操作
(function($){
  window.onSelectCalenderModal = function(dateText, inst){
	  removeForwardZ();
	  window.onSelectCalender(dateText, inst);
  };  

})(jQuery);
</script>
	<!-- IMART -->
	<imart type="jsspRpc" name="jsspRpcKanrenSearch" page="lo/contents/screen/common/kanren_search" callback="searchResultKanren" onErrorCallback="searchErrorKanren"></imart>
			<div class="container">
				<div class="row">
					<div class="col-12">
						<section class="show">
							<div class="mt-2 mb-2">
								<h2>関連文書選択</h2>
							</div>
							<div class="col-12 form-area mt-2 mb-2">
								<div class="col-12 row"><h4 class="indent">検索条件</h4></div>
								<form role="form" id="ipSearchForm">
									
									<div class="row mb-2">
										<div class="col-4 col-lg-2 t-header bg_ltorange brdr_dkgray text-center">申請日</div>
										<div class="infl col-6 col-lg-4 left-justified">
											<div class="input-group">
												<imart type="imuiTextbox" maxlength="10" class="form-control kanren_search_clear_target" id="sub_kanren_search_shinsei_from" name="sub_kanren_search_shinsei_from" value="" />
												<imart type="imuiCalendar" changeYear="true" changeMonth="true" floatable="true" altField="#sub_kanren_search_shinsei_from" showMonthAfterYear="true"  onSelect="onSelectCalender" onClose="onSelectCalenderModal" beforeShow="addForwardZ"/>
												<div class="input-group-append">
													<span class="input-group-text"><i class="fa fa-calendar"></i></span>
												</div>
											</div>
											<span class="text-center blanc">～</span>
											<div class="input-group">
												<imart type="imuiTextbox" maxlength="10" class="form-control kanren_search_clear_target" id="sub_kanren_search_shinsei_to" name="sub_kanren_search_shinsei_to" value="" />
												<imart type="imuiCalendar" changeYear="true" changeMonth="true" floatable="true" altField="#sub_kanren_search_shinsei_to" showMonthAfterYear="true"  onSelect="onSelectCalender" onClose="onSelectCalenderModal" beforeShow="addForwardZ" />
												<div class="input-group-append">
													<span class="input-group-text"><i class="fa fa-calendar"></i></span>
												</div>
											</div>
										</div>
										<div class="col-2 t-header bg_ltorange brdr_dkgray text-center">ステータス</div>
										<div class="col-4 left-justified">
											<div class="input-group">
												<imart type="imuiSelect" class="custom-select kanren_search_clear_target" id="sub_kanren_search_status" list=$status_list />
											</div>
										</div>
									</div>
									
									<div class="form-group row mb-2">
										<div class="col-1 t-header bg_ltorange brdr_dkgray text-center">文書種別</div>
										<div class="col-2 left-justified">
											<div class="input-group">												
												<imart type="imuiSelect" class="custom-select kanren_search_clear_target" name="sub_kanren_search_doc_type" id="sub_kanren_search_doc_type" list=$doc_type_list />
											</div>
										</div>
										<div class="col-1 t-header bg_ltorange brdr_dkgray text-center">文書番号</div>
										<div class="col-2 left-justified">
											<div class="input-group">												
												<input id="sub_kanren_search_bunsho_id" type="text" maxlength="1024" class="form-control kanren_search_clear_target">
											</div>
										</div>
										<div class="col-2 t-header bg_ltorange brdr_dkgray text-center">文書名</div>
										<div class="col-4 left-justified">
											<div class="input-group">
												<input id="sub_kanren_search_shinsei_nm" type="text" maxlength="1024" class="form-control kanren_search_clear_target">
											</div>
										</div>
									</div>
									<div class="form-group row mb-2">
										<div class="col-1 t-header bg_ltorange brdr_dkgray text-center">契約種別</div>
										<div class="col-2 left-justified">
											<div class="input-group">												
												<imart type="imuiSelect" class="custom-select kanren_search_clear_target" name="sub_kanren_search_keiyaku_cls" id="sub_kanren_search_keiyaku_cls" list=$keiyaku_cls_list />
											</div>
										</div>
										<div class="col-1 t-header bg_ltorange brdr_dkgray text-center">担当者</div>
										<div class="col-2 left-justified">
											<div class="input-group">												
												<input id="sub_kanren_search_tantou_sha" type="text" maxlength="1024" class="form-control kanren_search_clear_target">
											</div>
										</div>
										<div class="col-2 t-header bg_ltorange brdr_dkgray text-center">ライセンシー名</div>
										<div class="col-4 left-justified">
											<div class="input-group">
												<input id="sub_kanren_search_kaisha_nm" type="text" maxlength="1024" class="form-control kanren_search_clear_target">
											</div>
										</div>
									</div>
									
									<div class="form-group row mb-2" style="display:none;">
										
										<div class="col-2"></div>
										<div class="col-4">
											<div class="input-group">
												<!-- 以下のINPUTがないとENTER検索で遷移してしまう -->
												<input id="dummy_input" type="text" style="display:none;">
											</div>
										</div>
									</div>
								</form>
								</form>
							</div>
							<div class="form-group row mb-2">
								<div class="flex_btn">
									<div class="col-12">
										<span class="blanc">
											<button type="button" class="bg_orange txt_dark" id="sub_kanren_search_start"><i class="fas fa-search fa-2x"></i><span>検索</span></button>
											<button type="button" class="brdr_dkgray txt_dark" id="sub_kanren_search_clear"><i class="fas fa-eraser fa-2x"></i><span>クリア</span></button>
										</span>
									</div>
								</div>
							</div>
							<div class="col-12 border-bottom mt-2 mb-2">
								<table id="sub_kanren_search_result" class="table bnadium-table" style="width: 100%;">
									<thead>
										<tr role="row">
											<th class="coL_50" style="width: 30px;"></th>
											<th class="coL_150" style="width: 60px;">ステータス</th>
											<th class="coL_150" style="width: 80px;">文書ID</th>
											<th class="coL_150" style="width: 100px;">文書種別</th>
											<th class="coL_150" style="width: 200px;">文書名</th>
											<th class="coL_150" style="width: 150px;">タイトル</th>
											<th class="coL_150" style="width: 150px;">ライセンシー</th>
										</tr>
									</thead>
									<tbody>
									</tbody>
								</table>
							</div>
							
							<div class="form-group row mb-2">
								<div class="flex_btn">
									<div class="col-12">
										<span class="blanc">
											<button type="button" class="bg_orange txt_dark" id="sub_kanren_search_record_select" disabled><i class="fas fa-search fa-2x"></i><span>選択</span></button>
										</span>
									</div>
								</div>
							</div>

						</section>
					</div>
				</div>
			</div>
<script type="text/javascript">
$(function () {

	function escapeStr(value) {
	  return value.replace(/&/g, "&amp;")
	    .replace(/"/g, "&quot;")
	    .replace(/'/g, "&#039;")
	    .replace(/</g, "&lt;")
	    .replace(/>/g, "&gt;")
	    .replace(/\n/g, "<br>");
	}
	
	var changeSelectBtnDisabled = function () {
		if($("[name=row_check_ip]:checked").val()) {
			$("#sub_kanren_search_record_select").prop('disabled', false);
		} else {
			$("#sub_kanren_search_record_select").prop('disabled', true);
		}
	}
	
	// ENTERで検索
	var enterPressFlg = false;
	$('form#ipSearchForm input').keyup(function() {
		if(event.keyCode == 13 && !enterPressFlg) {
			enterPressFlg = true;
			$('#sub_kanren_search_start').click();
		}
	});

	var ipSelectDataTable = null;
	var checkedDataIndex = null;
	$("#sub_kanren_search_start").click(function() {

		// 表のクリア
	    if (ipSelectDataTable == null ) {
			ipSelectDataTable = $('#sub_kanren_search_result').DataTable({
				data: [],
				// 件数切替機能 無効
				lengthChange: false,
				// 検索機能 無効
				searching: false,
				// ソート機能 有効
				ordering: true,
				// 初期ソート 無効
				order: [],
				// 情報表示 無効
				info: false,
				// ページング機能 無効
				paging: true,
				// １ページあたりの表示件数
	               pageLength: 10,
	               pagingType: "full_numbers",
	               // 横スクロールバーを有効にする (scrollXはtrueかfalseで有効無効を切り替えます)
			    scrollX: false,
	               dom: "<tr><'row'<'col-4'i><'col-4 text-center'p><'col-4'>>",
	       		"language": {
	       			"processing":   "処理中...",
	       			"lengthMenu":   "_MENU_ 件表示",
	       			"zeroRecords":  "データはありません。",
	       			"info":         "全 _TOTAL_ 件中 _START_ 件から _END_ 件まで表示",
	       			"infoEmpty":    " 0 件中 0 から 0 まで表示",
	       			"infoFiltered": "（全 _MAX_ 件より抽出）",
	       			"infoPostFix":  "",
	       			"search":       "検索:",
	       			"url":          "",
	       			"paginate": {
	       				"first":    "<i class='fas fa-backward' aria-hidden='true'></i>",
	       				"previous": "<i class='fas fa-caret-left' aria-hidden='true'></i>",
	       				"next":     "<i class='fas fa-caret-right' aria-hidden='true'></i>",
	       				"last":     "<i class='fas fa-forward' aria-hidden='true'></i>"
	       			}
	       		},
	               columns: [
					{data: "selected", targets: 0,  visible: true,
					    createdCell: function (cell, cellData, rowData, rowIndex, colIndex) {
					      $(cell).addClass("brdr_ltgray text-center align-middle").css("width","30px");
					    },
						render:function(data, type, row, meta) {
							var html = '';
							html += '<div class="input-group text-center align-middle">';
							<imart type="condition" validity=$radio_mode negative>
							html += '<input type="checkbox" name="row_check_ip" ' + (data ? 'checked="checked"' : "") + '>';
							</imart>
							<imart type="condition" validity=$radio_mode>
							html += '<input type="radio" name="row_check_ip" ' + (data ? 'checked="checked"' : "") + '>';
							</imart>
							html += '</div>';
							return html;

						}
					},
					{data: "status_name", targets: 1,  visible: true, 
					    createdCell: function (cell, cellData, rowData, rowIndex, colIndex) {
					      $(cell).addClass("brdr_ltgray text-center align-middle").css("width","60px");
					    },
					    render:function(data, type, row, meta) {							
					    	return '<span class="' + row.mydoc_status_style + '">' + data + '</span>';
		       			}					    
					},
					{data: "kanren_bunsho_id", targets: 2,  visible: true, 
						createdCell: function (cell, cellData, rowData, rowIndex, colIndex) {	       			
							$(cell).addClass("brdr_ltgray text-left align-middle").css("width","80px");
					    },
						render:function(data, type, row, meta) {							
			       			if (row.bunsho_cls == 1){
			       				return '<a href="lo/contents/screen/kikaku/planning_detail_new?kikaku_id=' + data + '&new_window_flg=1" target="_blank">' + data + '</a>';
			       			}else if (row.bunsho_cls == 2){
			       				return '<a href="lo/contents/screen/kyodaku/permission_product_detail?kyodaku_id=' + data + '&new_window_flg=1" target="_blank">' + data + '</a>';
			       			}else if (row.bunsho_cls == 3){
			       				return '<a href="lo/contents/screen/keiyaku_naiyo/keiyaku_naiyo_detail?keiyaku_naiyo_id=' + data + '&new_window_flg=1" target="_blank">' + data + '</a>';
			       			}else{			       			
			       				return '<a href="lo/contents/screen/kawari/kawari_detail?bunsho_id=' + data + '&new_window_flg=1" target="_blank">' + data + '</a>';     				
			       			}

			       			return data;
		       			}
					},
					{data: "bunsho_cls_nm", targets: 3,  visible: true, 
					    createdCell: function (cell, cellData, rowData, rowIndex, colIndex) {
					      $(cell).addClass("brdr_ltgray text-left align-middle").css("width","100px");
					    }
					},
					{data: "bunsho_nm", targets: 4,  visible: true, 
					    createdCell: function (cell, cellData, rowData, rowIndex, colIndex) {
					      $(cell).addClass("brdr_ltgray text-left align-middle").css("width","200px");
					    }
					},					
					{data: "title_nm", targets: 5,  visible: true, 
					    createdCell: function (cell, cellData, rowData, rowIndex, colIndex) {
					    	$(cell).addClass("brdr_ltgray text-left align-middle").css("width","150px");
					    }
					},
					{data: "kaisha_nm", targets: 6,  visible: true, 
					    createdCell: function (cell, cellData, rowData, rowIndex, colIndex) {
					    	$(cell).addClass("brdr_ltgray text-left align-middle").css("width","150px");
					    }
					},
					{data: "bunsho_cls", targets: 7,  visible: false, 
					    createdCell: function (cell, cellData, rowData, rowIndex, colIndex) {
					      //$(cell).addClass("brdr_ltgray text-left align-middle").css("width","100px");
					    }
					}
					
				],
				createdRow: function(row, data, dataIndex) {
					$(row).attr('data-dataindex', dataIndex);
				}
			});
	    } else {
	    	ipSelectDataTable.rows().remove();
	    }

		// 検索条件取得
		var whereParam = {
			"doc_type":$.trim($("#sub_kanren_search_doc_type").val()),
			"shinsei_nm":$.trim($("#sub_kanren_search_shinsei_nm").val()),
			"shinsei_from":$.trim($("#sub_kanren_search_shinsei_from").val()),
			"shinsei_to":$.trim($("#sub_kanren_search_shinsei_to").val()),
			"status":$.trim($("#sub_kanren_search_status").val()),
			"bunsho_id":$.trim($("#sub_kanren_search_bunsho_id").val()),
			"kaisha_nm":$.trim($("#sub_kanren_search_kaisha_nm").val()),
			"keiyaku_cls":$.trim($("#sub_kanren_search_keiyaku_cls").val()),
			"tantou_sha":$.trim($("#sub_kanren_search_tantou_sha").val()),
		};
		
		// 検索
		jsspRpcKanrenSearch.searchKanrenList(whereParam);
		// インジケータ表示
		showIndicator();
	});
	
	// 検索後コールバック(jquery内関数を呼び出せるようにwindowに入れる)
	window.searchResultKanren = function(ret) {
		var dataSet = [];
        if (ret.countRow > 0) {
            // data配列を順に処理
            $.each(ret.data,function(index, elem) {
            	elem.selected = false;
                dataSet.push(elem);
        	});
        }
	    ipSelectDataTable.rows.add(dataSet).draw();
	    $("#sub_kanren_search_record_select").prop('disabled', true);
	    checkedDataIndex = null;

		// インジケータ非表示
        hideIndicator();
        enterPressFlg = false;
    }
	// 検索エラー後コールバック
	window.searchErrorKanren = function(res) {
        hideIndicator();
        enterPressFlg = false;
		try {
			imuiShowErrorMessage(res.toString(), [], true, 5000, true);
			return;
		} catch (ex) {
			imuiShowErrorMessage(ex.message, [], true, 5000, true);
		}
    }
	
	<imart type="condition" validity=$radio_mode>
	var radioMode = true;
	</imart>
	<imart type="condition" validity=$radio_mode negative>
	var radioMode = false;
	</imart>
	
	$(document).on("change", '#sub_kanren_search_result [name="row_check_ip"]', function(){
		var $this = $(this);
		var $tr = $this.closest("tr");
		var dataIndex = Number($tr.attr('data-dataindex'));
		if (radioMode && checkedDataIndex != null) {
			ipSelectDataTable.data()[checkedDataIndex].selected = false;
		}
		var titleData = ipSelectDataTable.data()[dataIndex];
		titleData.selected = $this.prop('checked');
		checkedDataIndex = dataIndex;
		changeSelectBtnDisabled();
	});

	// 「選択」ボタン
	$("#sub_kanren_search_record_select").click(function() {
		
		var selectedRecords = [];
		if (ipSelectDataTable != null) {
			selectedRecords = ipSelectDataTable.rows(function(index, data, node) {
		        return data.selected;
		    }).data().toArray();
		}
		console.log(selectedRecords);
		
		// ポップアップを閉じるので後始末しておく
		initializePopup();
		
		// 親画面のイベントを発火する
		var $popup = $(this).closest(".popup");
		$popup.trigger("selectedkanrenDatas", [selectedRecords]);
	});

	$("#sub_kanren_search_clear").click(function() {
		$(".kanren_search_clear_target").val("");
	});

	var initializePopup = function() {
		$("#sub_kanren_search_clear").click();
		if (ipSelectDataTable != null) {
			ipSelectDataTable.rows().remove().draw();
		}
		$("#sub_kanren_search_record_select").prop('disabled', true);
	};

	$(document).on("initializePopup", function(){
		initializePopup();
	});	

});
</script>
